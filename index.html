import React, { useState, useMemo } from "react";
import { CheckCircle, Circle, Plus } from "lucide-react";

const TodoApp = () => {
  const [schedule, setSchedule] = useState([
    {
      time: "4:00",
      tasks: [
        { id: "1", text: "ポットスイッチ", completed: false },
        { id: "2", text: "うがい", completed: false },
        { id: "3", text: "洗濯", completed: false },
        { id: "4", text: "ヨガ（10分）", completed: false, category: "S", duration: 10 },
        { id: "5", text: "体重測定", completed: false },
        { id: "6", text: "身支度（15分）", completed: false },
        { id: "7", text: "白湯", completed: false },
        { id: "8", text: "記録・スケジュール（15分）", completed: false, category: "S", duration: 15 },
        { id: "9", text: "洗濯物干し（15分）", completed: false, category: "H", duration: 15 },
      ],
    },
    {
      time: "5:00",
      tasks: [
        { id: "a", text: "コーヒー", completed: false },
        { id: "b", text: "読書（15分）", completed: false, category: "S", duration: 15 },
        { id: "c", text: "最重要タスク①（15分）", completed: false, category: "S", duration: 15 },
      ],
    },
  ]);

  const [newTask, setNewTask] = useState({
    category: "E",
    text: "",
    duration: 5,
  });

  const toggleTask = (timeIndex, taskId) => {
    const newSchedule = [...schedule];
    const task = newSchedule[timeIndex].tasks.find((t) => t.id === taskId);
    if (task) task.completed = !task.completed;
    setSchedule(newSchedule);
  };

  const resetTasks = () => {
    const resetSchedule = schedule.map((timeBlock) => ({
      ...timeBlock,
      tasks: timeBlock.tasks.map((task) => ({ ...task, completed: false })),
    }));
    setSchedule(resetSchedule);
  };

  const addCustomTask = () => {
    if (newTask.text.trim()) {
      const taskToAdd = {
        text: `${newTask.text}（${newTask.duration}分）`,
        completed: false,
        category: newTask.category,
        duration: newTask.duration,
      };
      setNewTask({ category: "E", text: "", duration: 5 });
    }
  };

  const timeSummary = useMemo(() => {
    const categories = ["E", "S", "M", "L", "H"];
    const summary = {};

    categories.forEach((category) => {
      const scheduledTime = schedule.reduce((total, timeBlock) => {
        const categoryTime = timeBlock.tasks
          .filter((task) => task.category === category && task.completed)
          .reduce((sum, task) => sum + (task.duration || 0), 0);
        return total + categoryTime;
      }, 0);
      summary[category] = scheduledTime;
    });

    return summary;
  }, [schedule]);

  return (
    <div className="max-w-screen-sm mx-auto bg-gray-100 min-h-screen p-4">
      <div className="bg-white shadow-md rounded-lg">
        <header className="flex justify-between items-center p-4 border-b">
          <h1 className="text-xl font-bold">My Routine</h1>
          <button onClick={resetTasks} className="text-blue-500 hover:underline">
            リセット
          </button>
        </header>

        <section className="p-4 border-b bg-gray-50">
          <h2 className="text-lg font-semibold mb-3">チェック済み時間</h2>
          <div className="grid grid-cols-3 gap-4 text-center">
            {Object.entries(timeSummary).map(([category, time]) => (
              <div key={category} className="bg-white p-2 rounded shadow-sm">
                <div className="font-bold">{category}</div>
                <div className="text-blue-600">{time}分</div>
              </div>
            ))}
          </div>
        </section>

        <section className="p-4 border-b">
          <h2 className="text-lg font-semibold mb-3">タスクを追加</h2>
          <div className="flex flex-col gap-3">
            <select
              value={newTask.category}
              onChange={(e) => setNewTask((prev) => ({ ...prev, category: e.target.value }))}
              className="border p-2 rounded"
            >
              {["E", "S", "M", "L", "H"].map((cat) => (
                <option key={cat} value={cat}>
                  {cat}
                </option>
              ))}
            </select>
            <input
              type="text"
              placeholder="タスク名"
              value={newTask.text}
              onChange={(e) => setNewTask((prev) => ({ ...prev, text: e.target.value }))}
              className="border p-2 rounded"
            />
            <select
              value={newTask.duration}
              onChange={(e) => setNewTask((prev) => ({ ...prev, duration: parseInt(e.target.value) }))}
              className="border p-2 rounded"
            >
              {[5, 10, 15, 20, 30].map((time) => (
                <option key={time} value={time}>
                  {time}分
                </option>
              ))}
            </select>
            <button onClick={addCustomTask} className="bg-blue-500 text-white p-2 rounded">
              タスクを追加
            </button>
          </div>
        </section>

        <section>
          {schedule.map((timeBlock, timeIndex) => (
            <div key={timeBlock.time} className="p-4 border-b">
              <h2 className="text-lg font-semibold mb-3">{timeBlock.time}</h2>
              {timeBlock.tasks.map((task) => (
                <div
                  key={task.id}
                  className="flex items-center mb-2 cursor-pointer"
                  onClick={() => toggleTask(timeIndex, task.id)}
                >
                  {task.completed ? (
                    <CheckCircle color="lightblue" size={24} className="mr-2" />
                  ) : (
                    <Circle color="gray" size={24} className="mr-2" />
                  )}
                  <span className={task.completed ? "line-through text-gray-400" : "text-gray-800"}>
                    {task.text}
                  </span>
                </div>
              ))}
            </div>
          ))}
        </section>
      </div>
    </div>
  );
};

export default TodoApp;
